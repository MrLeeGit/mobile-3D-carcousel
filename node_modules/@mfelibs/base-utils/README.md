# base-utils

v1.5.2

手浪前端基础库，提供 `Zepto` 等基本开发依赖。

## 安装:

```bash
yarn add @mfelibs/base-utils
```

## 模块

本库包含以下 6 模块：
- `Zepto`  DOM 操作库
- `FastClick`  解决移动端点击延迟
- `BaseModule`  组件基类
- `Event` 订阅，派发事件
- `Utils`  通用函数库
- `Page` 页面生命周期

并且全局注册了 `SINA_NEWS` 对象作为业务公共命名空间
```javascript
// 挂载全局命名空间
window.SINA_NEWS = { Page.ready, event }
```

### Zepto 模块

作为项目核心依赖，内部集合了 `zepto, event, ajax, form, data, callbacks, deferred ` 共 7 个功能模块

#### 使用

默认导入
```javascript
import $ from '@mfelibs/base-utils'
```

具名导入
```javascript
import { $ } from '@mfelibs/base-utils'
```

#### Tips
由于內建了 Zepto 的 `deferred` 模块，因此在使用 `Ajax` 类方法时，推荐使用链式调用处理回调：

```javascript
$.get('example.php', {
  page: 1
})
.done(function(res) {
  alert('success')
})
.fail(function(err) {
  alert('error')
})
.always(function(res) {
  alert('finished')
})
```

### FastClick 模块

由于移动端设备上存在 `300ms` 点击延迟问题，可引入 `FastClick` 模块加快点击响应。

注意：在 `v1.3.0` 以前的版本中，当 `@mfelibs/base-utils` 被引入时，`FastClick` 将在 DOM 渲染就绪后自动完成初始化。 在`v1.3.0` 及以后的版本中需要**手动**完成初始化，此举是为了在页面不需要 `FastClick`时以减小打包体积。

```javascript
import { FastClick, Page } from '@mfelibs/base-utils'

Page.ready(function(ctx) {
  FastClick(document.body)
})
```

### BaseModule 模块
`BaseModule` 为组件的管理中心，管理组件之间的运行上下文。开发者在开发业务组件时，应将其作为父类继承。

以下示例为功能组件 `Foo` 继承了基础组件 `BaseModule`：
```javascript
import { BaseModule } from '@mfelibs/base-utils';

class Foo extends BaseModule {
  constructor(el, options, isRoot) {
    super(el, options, isRoot)  // 必须首先调用父类构造器
    this.say()
  }

  say() {
    ...
  }
}

export default Foo
```
由于 Foo 继承了 BaseModule，因此在 Foo 的构造器内第一行，需要显式的通过 `super` 关键字来调用父类构造器完成整个对象的初始化。当通过 `new` 关键字生成 Foo 实例时，BaseModule 会将新创建的 Foo 实例对象注册到当前的运行上下文 `context` 对象中。


#### constructor 构造器

方法签名：**constructor(el, options, isRoot)**

BaseModule 的构造器接受三个参数：

1. `el` 要绑定的 DOM 元素
2. `options` 组件的配置信息，对象类型
3. `isRoot` 配置应用策略，布尔类型

##### el

可选值为原生 `Element` 对象，`Zepto` 对象或 `CSS` 选择器。

实例化对象后， BaseModule 将会把 el 转换为 `Zepto` 对象，并挂载到当前实例的 `$el` 属性上
```javascript
const foo = new Foo('.foo', config)
foo.$el
```

**注意，当传递的 el 参数为元素集合时，BaseModule 将始终把 `$el` 赋值为元素集合的第一个元素。**

##### options

`options` 为组件的配置对象，有两种方式可供传递：

1. 在 DOM 节点上指定
2. 通过构造器注入

从优先级上来讲，默认的 `DOM 配置 > 构造器注入`，即：在两者均均使用的情况下，DOM 上的配置将会覆盖从构造器中传递的配置。

假设有如下 html 结构：
```html
<div id="foo"></div>
```

###### 在 DOM 节点上指定配置

通过 HTML5 的自定义属性 `data-*` 来指定 `name` 与 `hobby` 配置
```html
<div id="foo" data-name="fish" datas-hobby="swim"></div>
```
```javascript
const foo = new Foo('#foo')
```


###### 通过构造器注入配置

直接在构造器上传递 `options` 参数

```javascript
const options = {
  name: 'fish',
  hobby: 'swim'
}
const foo = new Foo('#foo', options)
```

##### isRoot

`isRoot` 用于指定配置应用策略，当同时指定 DOM 配置与构造器配置时，判断是否将构造器配置覆盖到 DOM 配置上，默认值：`false`。

由于 BaseModule 提供了两种传递配置信息的方式，所以当两者同时使用时，就会陷入配置优先级的问题。BaseModule 的默认策略为 DOM 优先，即，实例化对象时，以构造器传入的 `options` 对象为基底，然后解析绑定的 DOM 上的 `data-*` 属性，并逐条应用到基底中，当存在同名字段时，DOM 属性将覆盖基底属性，否则进行合并。

isRoot 提供了控制权的开关，当指定为 `true` 时，强制使用构造器配置来覆盖 DOM 配置。
```html
<div id="foo" data-name="fish" datas-hobby="swim" data-id="vv314"></div>
```
```javascript
import Foo from '@mfelibs/foo';

const options = {
  name: 'cat',
  hobby: 'sleep',
  color: 'black'
}
const f1 = new Foo('#foo', options)
f1.getOptions()
// 默认 DOM 配置优先
// {id: 'vv314', name: 'fish', hobby='swim', color: 'black'}

const f2 = new Foo('#foo', options, true)
f2.getOptions()
// 指定 isRoot 参数，强制 options 合并覆盖 DOM 配置
// {id: 'vv314', name: 'cat', hobby='sleep', color: 'black'}
```

#### BaseModule.register 静态方法

方法签名：**BaseModule.register(Class, aligs)**

该方法接受两个参数，第一个参数为继承了 BaseModule 的组件的构造函数，第二个参数为构造函数的别名。调用后将会把组件的构造器注册到在当前页面的 `context` 对象中，以备将来的模板`自动绑定`时使用。
```javascript
class Foo extends BaseModule {...}
BaseModule.register(Foo, 'foo')   // 注册 Foo，并取别名为 'foo'
```


#### 自动绑定

除了通过 `new` 关键字来实例化组件对象外，还可以通过模板的 `mr-type` 属性来自动绑定并且实例化对象。



#### getOptions 方法

方法签名：**getOptions (defConfig)**

该方法接受一个可选的对象类型参数 `defConfig`，用于指定默认缺省配置，调用后返回经过合并的最终配置。

```javascript
import { BaseModule } from '@mfelibs/base-utils';

const defaults = {
  name: 'animal',
  hobby: '',
  color: 'white'
}

class Foo extends BaseModule {
  constructor(el, options, isRoot) {
    super(el, options, isRoot)

  // 将 defaults 与当前 options 合并，获取最终配置
    this.settings = this.getOptions(defaults)
  }

  say() {
    ...
  }
}
```

#### getContext 方法

获取页面运行时的上下文对象。

假设 `Foo` 继承了 `BaseModule`，当通过 `new` 关键字实例化 Foo 时，BaseModule 会将新创建的实例对象注册到当前的运行上下文 `context` 对象中。可以通过调用实例的  `getContext` 方法获取该上下文对象。

#### 事件方法

继承了 `BaseModule` 的实例对象，将会具备 `on`, `one`, `emit`, `off` 四个事件相关的实例方法：
```javascript
import Foo from '@mfelibs/foo';

const foo = new Foo('sina')

foo.on('say', (msg) => {
  console.log('say', msg)
})
foo.emit('say', 'hello')  // 'say hello'
```

### Page 模块

该模块用于绑定页面的生命周期函数，现有的生命周期有 `ready` 与 `destroy`

#### ready

ready 事件在 DOM 就绪并且组件自动绑定（如有）完成后触发。ready 就绪后，可以拿到页面的 context 对象

```javascript
import { Page } from '@mfelibs/base-utils';

Page.ready((context) => {

})
```

#### `*`destroy

开发中，用于销毁 `context` 中的对象

#### context 对象
`context` 对象定义为全局的组件上下文对象，可以作为组件间通信的桥梁。`context` 内部拥有 `modules` 属性，保存了当前页面运行时注册的所有组件信息，必要时，不同的组件实例之间可以互相访问。

`modules` 的值为类数组对象，以 `键-组件名: 值-组件实例列表` 对的形式保存着当前页面所有组件的实例对象。


### Event 模块

该模块包含了事件相关的方法，用于定义页面级的事件。可以通过 `on` 订阅事件，通过 `emit` 来派发事件。

##### on

监听事件，接收两个参数，分别为要注册事件名称，事件触发时对应的处理函数。由 on 方法注册的事件可被多次响应
```javascript
/**
 * 监听事件
 * @param  {String}   key 事件名称
 * @param  {Function} fn  回调函数
 */
Event.on(key, fn)
```

##### emit

触发事件，接收一至多个参数，其中第一个参数为要触发的事件名称，其余参数为要传递的信息对象
```javascript
/**
 * 触发事件
 * @param  {String}   key 事件名称
 * @param  {...arg} 参数
 */
Event.emit(key[, msgData, ...])
```

##### one

使用上与 `on` 方法类似，接收两个参数，分别为事件名称及对应的处理函数，与通 `on` 不同的是，通过 `one` 注册的事件只会被处理一次
```javascript
/**
 * 监听一次
 * @param  {String}   key 事件名称
 * @param  {Function} fn  回调函数
 */
Event.one(key, fn)
```

##### showEvents

查看已注册的事件列表，可接受一个 String 类型的 `type` 参数。
当未传递 type 参数时，showEvents 方法返回值一个对象，包含 `on` 与 `one` 属性，属性值为相应事件名组成的数组。
当传递 type 参数时，type 的可选值有 `'one'` 与 `'on'`，showEvents 方法执行后将直接返回相应事件名组成的数组
```javascript
/**
 * 查看已注册的事件列表
 * @param  {String}   type 事件类型，可选值 ['one' | 'on']
 * @return {Obejct | Array}      事件名对象或列表
 */
Event.showEvents(type)
```

##### off

注销事件
```javascript
/**
 * 注销事件
 * @param  {String}   key 事件名称
 */
Event.off(key)
```


### SINA_NEWS 对象

#### ready 方法

ready 方法代理了 Page 上的 ready 事件



####  event 属性
值为对象，为 `Event` 模块的对外接口
**注意：此对象并未暴露 `showEvents` 接口**




### Utils

`Utils` 内包含了一些常用的公共函数

- `random`  -- 返回指定精度整型随机数
- `q`  -- 包装 querySelectorAll
- `getUrlParam` -- 获取url参数
- `isWechat`  -- 判断是否为微信浏览器
- `limitStr` -- 限制字符串长度，以省略号结尾
- `storage` -- 设置/获取 localStorage
- `isEmpty` -- 判断字符串、数组、对象内容是否为空
- `testEmail` -- 邮箱格式验证
- `likeNumber` -- 判断是否为数字或数字字符串
- `checkCookie` -- 检查 cookie 是否可用
- `getCookie` -- 获取 cookie
- `setCookie` -- 设置 cookie
- `delCookie` -- 删除 cookie


```javascript
/**
 * 返回指定精度整型随机数
 * @param  {Number} min 左边距
 * @param  {Number} max 右边距
 * @return {Number}   指定范围随机数
 * random(1, 3)  // 1 | 2 | 3
 */
Utils.random(min, max)

/**
 * 原生选择器
 * @param  {...selector} id, class, tag
 * @return {Element} 匹配元素列表
 * e.g.
 * q('.name')  // Element
 * q('.name', '.profile')  // Element
 */
Utils.q(selector)

/**
 * 获取url参数
 * @param  {String} name 参数名
 * @return {String}      参数值
 * e.g.
 * // http://www.vv314.com?type=1&id=1
 * getUrlParam('id')  // 1
 * getUrlParam('name')  // null
 */
Utils.getUrlParam(name)

/**
 * 判断是否为微信浏览器
 * @return {Boolean}
 */
Utils.isWechat()

/**
 * 字符串超出截取，以省略号结尾
 * @param  {String} str    待截取字符串
 * @param  {Number} maxlength 长度
 * @return {String}        截取结果
 * e.g.
 * limitStr('abcdefg', 4) // abcd...
 */
Utils.limitStr(str, maxlength)

/**
 * 设置/获取 localStorage
 * 当 value 缺省时为获取数据, value 为对象时,执行序列化
 * @param  {String} name  数据名
 * @param  {String} [value] 数据项
 * e.g.
 * storage('goodid')  // 获取 goodid
 * storage('profile', {name: fish, gender: 1})  // 存储 profile
 */
Utils.storage(name, value)

/**
 * 判断字符串、数组、对象内容是否为空
 * @param  {String | Obejct}  obj  数据源
 * @return {Boolean}  判断结果
 * e.g.
 * isEmpty('')  // true
 * isEmpty([])  // true
 * isEmpty({})  // true
 * isEmpty({name: 'fish'})  // false
 */
Utils.isEmpty(obj)

/**
 * 判断是否为数字或数字字符串
 * @param  {Number | String} 数据
 * @return {Boolean}       判断结果
 * e.g.
 * likeNumber(5)  // true
 * likeNumber('8')  // true
 * likeNumber('2a')  // false
 */
Utils.likeNumber(value)

/**
 * 邮箱格式验证
 * @param  {String} email  email地址
 * @return {Boolean}  验证结果
 * e.g.
 * vaildEmail('vv314@foxmail.com')  // true
 */
Utils.testEmail(email)

/**
 * 检查 cookie 是否可用
 * @return {Boolean} true: 支持  false: 不支持
 */
Utils.checkCookie()

/**
 * 获取 Cookie
 * @param  {String} name  cookie名称
 * @return {String}
 * e.g.
 * // cookie: name=fish
 * getCookie('name')  // fish
 * getCookie('age')  // ''
 */
Utils.getCookie(name)

/**
 * 设置 Cookie
 * @param {String} name   cookie 名
 * @param {String} value  cookie 值
 * @param {Number} days   有效时间
 * @param {String} domain 域名
 * e.g.
 * setCookie('isRead', true)
 * setCookie('app', 'sina news', 15)
 */
Utils.setCookie(name, value, days, domain)

/**
 * 删除 Cookie
 * @param {String} name  cookie 名称
 * @param {String} domain  域名
 */
Utils.delCookie(name, domain)

/**
 * 格式化时间
 * @param {Date} date  Date 对象
 * @return {Object}  结果
 * e.g.
 * parseDate(new Date)
 * output:
 * {y: 2017, M: 07, d: 13, h: 11, m: 13, s: 15}
 */
Utils.parseDate(date)

/**
 * 节流函数
 * @param  {Function} method 函数
 * @param  {Number} delay   间隔时间
 * @return {Function}        新函数
 * e.g.
 * const resize = throttle(function() {console.log('resize')}, 200)
 * $(window).on('resize', resize)  // 等待 200ms 执行一次 resize
 */
Utils.throttle(method, delay)

// 加载单个脚本
// load('https://sina.cn/a.js', callback)
//
// 串行加载脚本
// load.series(['https://sina.cn/a.js', 'https://sina.cn/b.js'], callback)
//
// 并行加载脚本
// load.parallel(['https://sina.cn/a.js', 'https://sina.cn/b.js'], callback)
Utils.load(url, callback)

/**
 * 检测手势方向
 * @param  {threshold} 滑动阈值，缺省 20
 * e.g
 * var touch = new Touch()
 *
 * touch.listen('#app', function(direction) {
 *   console.log(direction)
 * })
 */
Utils.Touch(threshold)
```

## 外部模块

### eruda

集成 [eruda](https://github.com/liriliri/eruda/blob/master/doc/README_CN.md) 调试工具，通过 url 参数 `_devtools=1` 开启。

### mdebug

[mdebug](http://cnpm.sina.com.cn/package/@mfelibs/base-tool-mdebug) 移动端调试组件，能够方便的查看 conosle 信息与 dom检查，通过 url 参数 `_mlog=1` 开启
