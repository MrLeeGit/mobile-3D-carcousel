import $ from './zepto.js'
import { context, SID } from './context.js'

const moduleFactory = {
  init() {
    // const $mDOMs = $(`[${sid}auto]`).not(`[${sid}auto=false]`)
    const $mDOMs = $(`[${SID}]`).not('[mr-auto=false]')

    $mDOMs.each((i, el) => {
      // 查询 context 实例池，避免用户在 ready 事件前
      // 调用 new 构造实例后，框架扫描 DOM 自动初始化多次
      if(!context.getInstance(el)) {
        this.createModule(el)
      }
    })

    return context
  },

  createModule(el) {
    const tName = $(el).attr(SID)
    const Module = context.getProto(tName)
    let modObj = null

    if(typeof(Module) === 'undefined') {
      console.warn(`Module [${tName}] is not regiested.`)
      return null
    }

    el['__src'] = 'dom'
    modObj = new Module(el)
    delete el['__src']

    return modObj
  }
}

export default moduleFactory
